import { useQuery } from '@tanstack/react-query'
import axios from 'axios'
import { useState } from 'react'

interface Vulnerability {
  id: string
  severity: string
  title?: string
  description?: string
  package: string
  version: string
}

interface VulnerabilityScanResult {
  manager: string
  vulnerabilities: Vulnerability[]
  supported: boolean
  error?: string
  metadata?: any
}

interface VulnerabilityScanProps {
  managerId: string
}

const fetchVulnerabilities = async (managerId: string): Promise<VulnerabilityScanResult> => {
  const response = await axios.get<VulnerabilityScanResult>(`/api/advanced/${managerId}/vulnerabilities`)
  return response.data
}

function VulnerabilityScan({ managerId }: VulnerabilityScanProps) {
  const [isOpen, setIsOpen] = useState(false)

  const { data, isLoading, error, refetch } = useQuery({
    queryKey: ['vulnerabilities', managerId],
    queryFn: () => fetchVulnerabilities(managerId),
    enabled: isOpen,
  })

  const getSeverityColor = (severity: string) => {
    const lower = severity?.toLowerCase() || ''
    if (lower.includes('critical') || lower.includes('high')) return 'text-red-600 bg-red-50'
    if (lower.includes('moderate') || lower.includes('medium')) return 'text-orange-600 bg-orange-50'
    if (lower.includes('low')) return 'text-yellow-600 bg-yellow-50'
    return 'text-gray-600 bg-gray-50'
  }

  return (
    <div className="border border-gray-200 rounded-lg overflow-hidden">
      <button
        onClick={() => {
          setIsOpen(!isOpen)
          if (!isOpen && !data) {
            refetch()
          }
        }}
        className="w-full px-4 py-3 bg-white hover:bg-gray-50 flex items-center justify-between transition-colors"
      >
        <div className="flex items-center gap-2">
          <svg className="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
          </svg>
          <span className="font-medium text-gray-900">Scan Vulnerabilities</span>
        </div>
        <svg
          className={`w-5 h-5 text-gray-500 transition-transform ${isOpen ? 'rotate-180' : ''}`}
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
        </svg>
      </button>

      {isOpen && (
        <div className="border-t border-gray-200 bg-gray-50 p-4">
          {isLoading && (
            <div className="flex items-center justify-center py-8">
              <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
            </div>
          )}

          {error && (
            <div className="bg-red-50 border border-red-200 rounded p-3 text-sm text-red-700">
              Error: {error instanceof Error ? error.message : 'Unknown error'}
            </div>
          )}

          {data && !data.supported && (
            <div className="bg-yellow-50 border border-yellow-200 rounded p-3 text-sm text-yellow-700">
              {data.message || 'Vulnerability scanning not supported for this manager'}
            </div>
          )}

          {data && data.error && (
            <div className="bg-orange-50 border border-orange-200 rounded p-3 text-sm text-orange-700">
              {data.error}
            </div>
          )}

          {data && data.supported && !data.error && (
            <div>
              {data.vulnerabilities.length === 0 ? (
                <div className="bg-green-50 border border-green-200 rounded p-3 text-sm text-green-700">
                  No vulnerabilities found!
                </div>
              ) : (
                <div className="space-y-2">
                  <div className="text-sm font-medium text-gray-700 mb-3">
                    Found {data.vulnerabilities.length} vulnerabilities
                  </div>
                  {data.vulnerabilities.map((vuln, index) => (
                    <div key={index} className="bg-white border border-gray-200 rounded p-3">
                      <div className="flex items-start justify-between gap-2">
                        <div className="flex-1">
                          <div className="font-medium text-gray-900">{vuln.package}</div>
                          <div className="text-sm text-gray-600 mt-1">
                            {vuln.title || vuln.description || vuln.id}
                          </div>
                          <div className="text-xs text-gray-500 mt-1">Version: {vuln.version}</div>
                        </div>
                        <span className={`px-2 py-1 rounded text-xs font-medium ${getSeverityColor(vuln.severity)}`}>
                          {vuln.severity}
                        </span>
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </div>
          )}
        </div>
      )}
    </div>
  )
}

export default VulnerabilityScan
